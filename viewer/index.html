<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Permit Coverage Dashboard ‚Äî Martin Demo</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.css" />
  <script src="https://unpkg.com/maplibre-gl@5.1.0/dist/maplibre-gl.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: #0b0d14;
      color: #e0e2e8;
      overflow: hidden;
      height: 100vh;
      display: flex;
    }

    /* ===================== SIDEBAR ===================== */
    .sidebar {
      width: 360px;
      min-width: 360px;
      height: 100vh;
      background: #0e1019;
      border-right: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 20;
    }

    .sidebar-header {
      padding: 20px 20px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    }

    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .sidebar-brand svg {
      flex-shrink: 0;
    }

    .sidebar-brand h1 {
      font-size: 18px;
      font-weight: 800;
      background: linear-gradient(135deg, #6ee7b7, #3b82f6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }

    .sidebar-brand .subtitle {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.35);
      font-weight: 500;
      letter-spacing: 0.3px;
    }

    /* Breadcrumbs */
    .breadcrumbs {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.4);
      flex-wrap: wrap;
    }

    .breadcrumb-item {
      cursor: pointer;
      color: #6ee7b7;
      transition: color 0.15s;
    }

    .breadcrumb-item:hover {
      color: #a7f3d0;
    }

    .breadcrumb-sep {
      color: rgba(255, 255, 255, 0.2);
    }

    .breadcrumb-current {
      color: rgba(255, 255, 255, 0.7);
      font-weight: 600;
    }

    /* Sidebar body */
    .sidebar-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px 20px;
    }

    .sidebar-body::-webkit-scrollbar {
      width: 4px;
    }

    .sidebar-body::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* Stat cards */
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .stat-card {
      padding: 14px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      transition: border-color 0.2s;
    }

    .stat-card:hover {
      border-color: rgba(110, 231, 183, 0.15);
    }

    .stat-value {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: -0.5px;
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.4);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .stat-value.green {
      color: #6ee7b7;
    }

    .stat-value.yellow {
      color: #fbbf24;
    }

    .stat-value.red {
      color: #f87171;
    }

    .stat-value.blue {
      color: #60a5fa;
    }

    /* Status bar */
    .section-title {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 10px;
    }

    .status-bar-container {
      margin-bottom: 20px;
    }

    .status-bar {
      display: flex;
      height: 10px;
      border-radius: 6px;
      overflow: hidden;
      margin-bottom: 10px;
      background: rgba(255, 255, 255, 0.04);
    }

    .status-bar .approved {
      background: #22c55e;
    }

    .status-bar .pending {
      background: #f59e0b;
    }

    .status-bar .denied {
      background: #ef4444;
    }

    .status-legend {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.5);
    }

    .status-legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-dot.approved {
      background: #22c55e;
    }

    .status-dot.pending {
      background: #f59e0b;
    }

    .status-dot.denied {
      background: #ef4444;
    }

    /* Hotspots */
    .hotspots-list {
      margin-bottom: 20px;
    }

    .hotspot-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.04);
      border-radius: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .hotspot-item:hover {
      background: rgba(110, 231, 183, 0.05);
      border-color: rgba(110, 231, 183, 0.12);
    }

    .hotspot-rank {
      width: 24px;
      height: 24px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      background: rgba(255, 255, 255, 0.05);
      color: rgba(255, 255, 255, 0.5);
      flex-shrink: 0;
    }

    .hotspot-info {
      flex: 1;
      min-width: 0;
    }

    .hotspot-name {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.8);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .hotspot-sub {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.35);
    }

    .hotspot-count {
      font-size: 14px;
      font-weight: 700;
      color: #6ee7b7;
      flex-shrink: 0;
    }

    /* Legend */
    .legend {
      margin-bottom: 20px;
    }

    .legend-gradient {
      height: 10px;
      border-radius: 6px;
      background: linear-gradient(90deg, #ef4444 0%, #f59e0b 40%, #22c55e 100%);
      margin-bottom: 6px;
    }

    .legend-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.35);
    }

    /* Sidebar footer */
    .sidebar-footer {
      padding: 12px 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 11px;
      color: rgba(255, 255, 255, 0.3);
    }

    .sidebar-footer a {
      color: #6ee7b7;
      text-decoration: none;
    }

    .sidebar-footer a:hover {
      text-decoration: underline;
    }

    /* ===================== MAP ===================== */
    .map-container {
      flex: 1;
      position: relative;
      height: 100vh;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Top controls */
    .map-controls {
      position: absolute;
      top: 16px;
      left: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 10;
      pointer-events: none;
    }

    .map-controls>* {
      pointer-events: auto;
    }

    .search-box {
      flex: 1;
      max-width: 360px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 10px 14px 10px 36px;
      background: rgba(12, 12, 20, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      color: #f0f0f0;
      font-family: inherit;
      font-size: 13px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .search-box input:focus {
      border-color: rgba(110, 231, 183, 0.3);
      box-shadow: 0 0 0 3px rgba(110, 231, 183, 0.08), 0 4px 20px rgba(0, 0, 0, 0.4);
    }

    .search-box input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    .search-icon {
      position: absolute;
      left: 11px;
      top: 50%;
      transform: translateY(-50%);
      color: rgba(255, 255, 255, 0.3);
    }

    .search-results {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      background: rgba(12, 12, 20, 0.95);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      max-height: 220px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      padding: 9px 14px;
      cursor: pointer;
      font-size: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      transition: background 0.15s;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-item:hover {
      background: rgba(110, 231, 183, 0.06);
    }

    /* Layer toggles */
    .layer-toggles {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: rgba(12, 12, 20, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      margin-left: auto;
    }

    .toggle-btn {
      padding: 7px 12px;
      border: none;
      border-radius: 8px;
      background: transparent;
      color: rgba(255, 255, 255, 0.45);
      font-family: inherit;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .toggle-btn:hover {
      color: rgba(255, 255, 255, 0.7);
    }

    .toggle-btn.active {
      background: rgba(110, 231, 183, 0.12);
      color: #6ee7b7;
    }

    /* Hover tooltip */
    .hover-info {
      position: absolute;
      bottom: 32px;
      right: 16px;
      padding: 12px 16px;
      background: rgba(12, 12, 20, 0.85);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      z-index: 10;
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      display: none;
      max-width: 280px;
    }

    .hover-info.visible {
      display: block;
    }

    .hover-info .hi-name {
      font-size: 14px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 6px;
    }

    .hover-info .hi-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2px;
    }

    .hover-info .hi-label {
      color: rgba(255, 255, 255, 0.4);
    }

    .hover-info .hi-val {
      font-weight: 600;
    }

    /* Loading overlay */
    .loading-overlay {
      position: absolute;
      inset: 0;
      z-index: 30;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(10, 10, 15, 0.85);
      backdrop-filter: blur(8px);
      transition: opacity 0.5s;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-text {
      font-size: 15px;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.6);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(110, 231, 183, 0.2);
      border-top-color: #6ee7b7;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* MapLibre overrides */
    .maplibregl-ctrl-group {
      background: rgba(12, 12, 20, 0.8) !important;
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08) !important;
      border-radius: 12px !important;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4) !important;
    }

    .maplibregl-ctrl-group button {
      background: transparent !important;
      border: none !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05) !important;
      width: 34px !important;
      height: 34px !important;
    }

    .maplibregl-ctrl-group button:last-child {
      border-bottom: none !important;
    }

    .maplibregl-ctrl-group button:hover {
      background: rgba(255, 255, 255, 0.06) !important;
    }

    .maplibregl-ctrl-group button .maplibregl-ctrl-icon {
      filter: invert(1) brightness(0.6);
    }

    .maplibregl-ctrl-attrib {
      background: rgba(12, 12, 20, 0.4) !important;
      color: rgba(255, 255, 255, 0.25) !important;
      font-size: 10px !important;
    }

    .maplibregl-ctrl-attrib a {
      color: rgba(255, 255, 255, 0.35) !important;
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="url(#g1)" stroke-width="2"
          stroke-linecap="round" stroke-linejoin="round">
          <defs>
            <linearGradient id="g1" x1="0" y1="0" x2="24" y2="24">
              <stop offset="0%" stop-color="#6ee7b7" />
              <stop offset="100%" stop-color="#3b82f6" />
            </linearGradient>
          </defs>
          <rect x="3" y="3" width="18" height="18" rx="2" />
          <path d="M3 9h18" />
          <path d="M9 21V9" />
        </svg>
        <div>
          <h1>Permit Coverage</h1>
          <div class="subtitle">Dashboard &middot; Martin Demo</div>
        </div>
      </div>
      <div class="breadcrumbs" id="breadcrumbs">
        <span class="breadcrumb-current">United States</span>
      </div>
    </div>

    <div class="sidebar-body" id="sidebar-body">
      <div class="stats-grid" id="stats-grid">
        <div class="stat-card">
          <div class="stat-value blue" id="stat-total">‚Äî</div>
          <div class="stat-label">Total Permits</div>
        </div>
        <div class="stat-card">
          <div class="stat-value green" id="stat-rate">‚Äî</div>
          <div class="stat-label">Approval Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value yellow" id="stat-pending">‚Äî</div>
          <div class="stat-label">Pending</div>
        </div>
        <div class="stat-card">
          <div class="stat-value red" id="stat-denied">‚Äî</div>
          <div class="stat-label">Denied</div>
        </div>
      </div>

      <div class="status-bar-container">
        <div class="section-title">Status Breakdown</div>
        <div class="status-bar" id="status-bar">
          <div class="approved" style="width:0%"></div>
          <div class="pending" style="width:0%"></div>
          <div class="denied" style="width:0%"></div>
        </div>
        <div class="status-legend">
          <div class="status-legend-item">
            <div class="status-dot approved"></div><span id="leg-approved">Approved</span>
          </div>
          <div class="status-legend-item">
            <div class="status-dot pending"></div><span id="leg-pending">Pending</span>
          </div>
          <div class="status-legend-item">
            <div class="status-dot denied"></div><span id="leg-denied">Denied</span>
          </div>
        </div>
      </div>

      <div class="legend">
        <div class="section-title">Coverage Heat</div>
        <div class="legend-gradient"></div>
        <div class="legend-labels"><span>Low Coverage</span><span>Moderate</span><span>High Coverage</span></div>
      </div>

      <div class="hotspots-list">
        <div class="section-title">Top Hotspots</div>
        <div id="hotspots-container"></div>
      </div>
    </div>

    <div class="sidebar-footer">
      Tiles by <a href="http://localhost:3000" target="_blank">Martin</a> &middot;
      Data <a href="https://protomaps.com" target="_blank">Protomaps</a> &middot;
      <a href="https://github.com/maplibre/martin" target="_blank">Docs</a>
    </div>
  </aside>

  <!-- MAP -->
  <div class="map-container">
    <div id="map"></div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-text">
        <div class="spinner"></div>Loading US boundaries‚Ä¶
      </div>
    </div>

    <div class="map-controls">
      <div class="search-box">
        <svg class="search-icon" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor"
          stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input id="search-input" type="text" placeholder="Search location..." autocomplete="off" />
        <div id="search-results" class="search-results"></div>
      </div>
      <div class="layer-toggles">
        <button class="toggle-btn active" data-layer="choropleth">‚óß Coverage</button>
        <button class="toggle-btn" data-layer="heatmap">üî• Hotspots</button>
        <button class="toggle-btn active" data-layer="markers">üìç Permits</button>
      </div>
    </div>

    <div class="hover-info" id="hover-info">
      <div class="hi-name" id="hi-name"></div>
      <div class="hi-row"><span class="hi-label">Total</span><span class="hi-val" id="hi-total"></span></div>
      <div class="hi-row"><span class="hi-label">Approved</span><span class="hi-val" style="color:#22c55e"
          id="hi-approved"></span></div>
      <div class="hi-row"><span class="hi-label">Pending</span><span class="hi-val" style="color:#f59e0b"
          id="hi-pending"></span></div>
      <div class="hi-row"><span class="hi-label">Denied</span><span class="hi-val" style="color:#ef4444"
          id="hi-denied"></span></div>
      <div class="hi-row"><span class="hi-label">Approval Rate</span><span class="hi-val" id="hi-rate"></span></div>
    </div>
  </div>

  <script type="module">
    import layersFn from 'https://esm.sh/protomaps-themes-base@4.1.0';
    import * as topojson from 'https://esm.sh/topojson-client@3';

    // ============================================================
    // SEEDED RANDOM
    // ============================================================
    let _seed = 42;
    function seededRandom() { _seed = (_seed * 16807) % 2147483647; return (_seed - 1) / 2147483646; }
    function randInt(min, max) { return Math.floor(seededRandom() * (max - min + 1)) + min; }

    // ============================================================
    // STATE FIPS  (name -> 2-digit code)
    // ============================================================
    const STATE_FIPS = {
      "Alabama": "01", "Alaska": "02", "Arizona": "04", "Arkansas": "05", "California": "06",
      "Colorado": "08", "Connecticut": "09", "Delaware": "10", "Florida": "12", "Georgia": "13",
      "Hawaii": "15", "Idaho": "16", "Illinois": "17", "Indiana": "18", "Iowa": "19",
      "Kansas": "20", "Kentucky": "21", "Louisiana": "22", "Maine": "23", "Maryland": "24",
      "Massachusetts": "25", "Michigan": "26", "Minnesota": "27", "Mississippi": "28", "Missouri": "29",
      "Montana": "30", "Nebraska": "31", "Nevada": "32", "New Hampshire": "33", "New Jersey": "34",
      "New Mexico": "35", "New York": "36", "North Carolina": "37", "North Dakota": "38", "Ohio": "39",
      "Oklahoma": "40", "Oregon": "41", "Pennsylvania": "42", "Rhode Island": "44", "South Carolina": "45",
      "South Dakota": "46", "Tennessee": "47", "Texas": "48", "Utah": "49", "Vermont": "50",
      "Virginia": "51", "Washington": "53", "West Virginia": "54", "Wisconsin": "55", "Wyoming": "56"
    };
    const FIPS_TO_STATE = Object.fromEntries(Object.entries(STATE_FIPS).map(([k, v]) => [v, k]));

    // ============================================================
    // MOCK PERMIT STATS GENERATOR
    // ============================================================
    function generatePermitStats(factor) {
      const base = factor * randInt(800, 3500);
      const total = Math.max(200, Math.round(base));
      const approvalRate = 0.45 + seededRandom() * 0.45;
      const approved = Math.round(total * approvalRate);
      const pendingRate = 0.05 + seededRandom() * 0.2;
      const pending = Math.round(total * pendingRate);
      const denied = Math.max(0, total - approved - pending);
      const avgDays = randInt(12, 90);
      return { total, approved, pending, denied, avgDays, approvalRate };
    }

    // State population factors
    const STATE_POP = {
      "01": 5, "02": 1, "04": 7, "05": 3, "06": 39, "08": 6, "09": 4, "10": 1, "12": 22, "13": 11,
      "15": 1, "16": 2, "17": 13, "18": 7, "19": 3, "20": 3, "21": 4, "22": 5, "23": 1, "24": 6,
      "25": 7, "26": 10, "27": 6, "28": 3, "29": 6, "30": 1, "31": 2, "32": 3, "33": 1, "34": 9,
      "35": 2, "36": 20, "37": 10, "38": 1, "39": 12, "40": 4, "41": 4, "42": 13, "44": 1, "45": 5,
      "46": 1, "47": 7, "48": 29, "49": 3, "50": 1, "51": 9, "53": 8, "54": 2, "55": 6, "56": 1
    };

    // ============================================================
    // FETCH REAL BOUNDARY DATA
    // ============================================================
    const [statesTopo, countiesTopo, countyNamesRaw] = await Promise.all([
      fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json').then(r => r.json()),
      fetch('https://cdn.jsdelivr.net/npm/us-atlas@3/counties-10m.json').then(r => r.json()),
      fetch('https://api.census.gov/data/2020/dec/pl?get=NAME&for=county:*').then(r => r.json()).catch(() => []),
    ]);

    // Build county FIPS ‚Üí name lookup from Census API
    const countyNameLookup = {};
    countyNamesRaw.slice(1).forEach(row => {
      // row = ["County Name, State", "stateFips", "countyFips"]
      const fullName = row[0];
      const fips = row[1] + row[2]; // e.g. "01001"
      // Strip ", State" suffix and " County" suffix for cleaner labels
      const shortName = fullName.split(',')[0].replace(/ County$| Parish$| Borough$| Census Area$| Municipality$/, '');
      countyNameLookup[fips] = shortName;
    });

    const statesGeoRaw = topojson.feature(statesTopo, statesTopo.objects.states);
    const countiesGeoRaw = topojson.feature(countiesTopo, countiesTopo.objects.counties);

    // Attach mock permit stats to each state feature
    _seed = 42;
    const stateStats = {};
    statesGeoRaw.features.forEach(f => {
      const fips = f.id;
      const name = FIPS_TO_STATE[fips];
      if (!name) return;
      const pop = STATE_POP[fips] || 1;
      const stats = generatePermitStats(pop);
      stateStats[fips] = stats;
      f.properties = { ...f.properties, name, fips, ...stats, rate: stats.approvalRate };
    });

    // Attach mock permit stats to each county feature
    _seed = 7919;
    const countyStats = {};
    countiesGeoRaw.features.forEach((f, i) => {
      const fips = f.id;
      const stateFips = fips.substring(0, 2);
      const stateName = FIPS_TO_STATE[stateFips];
      if (!stateName) return;
      const name = countyNameLookup[fips] || `County ${fips.substring(2)}`;
      const stats = generatePermitStats(seededRandom() * 3 + 0.3);
      countyStats[fips] = stats;
      f.properties = { ...f.properties, name, fips, stateFips, ...stats, rate: stats.approvalRate };
    });

    // Generate individual permit points within a county bbox
    function generatePermitPoints(countyFeature) {
      const coords = countyFeature.geometry.coordinates;
      // Get rough bbox
      let minLng = 180, maxLng = -180, minLat = 90, maxLat = -90;
      function scanRing(ring) { ring.forEach(([lng, lat]) => { if (lng < minLng) minLng = lng; if (lng > maxLng) maxLng = lng; if (lat < minLat) minLat = lat; if (lat > maxLat) maxLat = lat; }); }
      function scanCoords(c, depth) {
        if (depth === 0) scanRing(c);
        else c.forEach(sub => scanCoords(sub, depth - 1));
      }
      const gtype = countyFeature.geometry.type;
      if (gtype === 'Polygon') coords.forEach(ring => scanRing(ring));
      else if (gtype === 'MultiPolygon') coords.forEach(poly => poly.forEach(ring => scanRing(ring)));

      const fips = countyFeature.properties.fips || '00000';
      _seed = fips.split('').reduce((a, c) => a + c.charCodeAt(0), 0) * 53;
      const n = randInt(15, 40);
      const features = [];
      const types = ['Residential', 'Commercial', 'Industrial', 'Mixed-Use'];
      const stats = countyFeature.properties;
      const ar = stats.total > 0 ? stats.approved / stats.total : 0.7;
      const pr = stats.total > 0 ? stats.pending / stats.total : 0.15;

      for (let i = 0; i < n; i++) {
        const lng = minLng + seededRandom() * (maxLng - minLng);
        const lat = minLat + seededRandom() * (maxLat - minLat);
        const r = seededRandom();
        const status = r < ar ? 'Approved' : r < ar + pr ? 'Pending' : 'Denied';
        features.push({
          type: "Feature",
          geometry: { type: "Point", coordinates: [lng, lat] },
          properties: { status, type: types[randInt(0, 3)], id: `P-${randInt(10000, 99999)}`, days: randInt(5, 120) }
        });
      }
      return { type: "FeatureCollection", features };
    }

    // Generate mock cities within a county
    const CITY_NAMES = ['Springfield', 'Riverside', 'Fairview', 'Clinton', 'Madison', 'Georgetown', 'Arlington', 'Salem', 'Franklin', 'Chester', 'Bristol', 'Oxford', 'Hudson', 'Milton', 'Clayton', 'Monroe', 'Greenville', 'Newport', 'Ashland', 'Burlington', 'Dover', 'Hampton', 'Jackson', 'Lincoln', 'Marion', 'Oakland', 'Princeton', 'Richmond', 'Warren', 'Windsor'];
    const cityCache = {};
    function getCitiesForCounty(countyFips) {
      if (cityCache[countyFips]) return cityCache[countyFips];
      const cf = countiesGeoRaw.features.find(f => f.properties.fips === countyFips);
      if (!cf) return [];
      let minLng = 180, maxLng = -180, minLat = 90, maxLat = -90;
      function scanC(c) { if (typeof c[0] === 'number') { if (c[0] < minLng) minLng = c[0]; if (c[0] > maxLng) maxLng = c[0]; if (c[1] < minLat) minLat = c[1]; if (c[1] > maxLat) maxLat = c[1]; } else c.forEach(scanC); }
      scanC(cf.geometry.coordinates);
      _seed = countyFips.split('').reduce((a, c) => a + c.charCodeAt(0), 0) * 97;
      const n = randInt(3, 7);
      const cities = [];
      for (let i = 0; i < n; i++) {
        const lng = minLng + seededRandom() * (maxLng - minLng);
        const lat = minLat + seededRandom() * (maxLat - minLat);
        const stats = generatePermitStats(seededRandom() * 1.5 + 0.2);
        cities.push({
          name: CITY_NAMES[(parseInt(countyFips, 10) * 7 + i) % CITY_NAMES.length],
          lng, lat, countyFips,
          ...stats, rate: stats.approvalRate
        });
      }
      cityCache[countyFips] = cities;
      return cities;
    }

    function getCitiesGeoJSON(countyFips) {
      const cities = getCitiesForCounty(countyFips);
      return {
        type: "FeatureCollection",
        features: cities.map(c => ({
          type: "Feature",
          geometry: { type: "Point", coordinates: [c.lng, c.lat] },
          properties: { name: c.name, countyFips: c.countyFips, total: c.total, approved: c.approved, pending: c.pending, denied: c.denied, rate: c.rate, approvalRate: c.approvalRate, avgDays: c.avgDays }
        }))
      };
    }

    function getAllCitiesForState(stateFips) {
      const counties = countiesGeoRaw.features.filter(f => f.properties.stateFips === stateFips);
      const allCities = [];
      counties.forEach(cf => { allCities.push(...getCitiesForCounty(cf.properties.fips)); });
      return {
        type: "FeatureCollection",
        features: allCities.map(c => ({
          type: "Feature",
          geometry: { type: "Point", coordinates: [c.lng, c.lat] },
          properties: { name: c.name, countyFips: c.countyFips, total: c.total, approved: c.approved, pending: c.pending, denied: c.denied, rate: c.rate, approvalRate: c.approvalRate, avgDays: c.avgDays }
        }))
      };
    }

    // Hide loading
    document.getElementById('loading-overlay').classList.add('hidden');

    // ============================================================
    // MAP SETUP
    // ============================================================
    const MARTIN_URL = window.location.port === '8080'
      ? `${window.location.protocol}//${window.location.hostname}:8080/tiles`
      : 'http://localhost:3000';

    function buildStyle() {
      const layers = layersFn("protomaps", "dark");
      return {
        version: 8,
        glyphs: "https://protomaps.github.io/basemaps-assets/fonts/{fontstack}/{range}.pbf",
        sources: {
          protomaps: {
            type: "vector",
            tiles: [`${MARTIN_URL}/20260210/{z}/{x}/{y}`],
            maxzoom: 15,
            attribution: '¬© <a href="https://openstreetmap.org">OSM</a>'
          }
        },
        layers
      };
    }

    const map = new maplibregl.Map({
      container: 'map',
      style: buildStyle(),
      center: [-98.5, 39.8],
      zoom: 3.8,
      maxZoom: 16,
      attributionControl: true,
    });
    map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'top-right');

    // ============================================================
    // APP STATE
    // ============================================================
    let currentLevel = 'national';
    let currentStateFips = null;
    let currentCountyFips = null;
    let currentCityName = null;
    let stateSubMode = 'counties'; // 'counties' | 'cities'
    let layerVisibility = { choropleth: true, heatmap: false, markers: true };

    const RATE_COLOR = [
      'interpolate', ['linear'], ['get', 'rate'],
      0.4, '#ef4444',
      0.55, '#f97316',
      0.65, '#f59e0b',
      0.75, '#eab308',
      0.85, '#84cc16',
      0.92, '#22c55e'
    ];

    // ============================================================
    // BUILD GEOJSON
    // ============================================================
    function getStateGeoJSON() {
      return {
        type: "FeatureCollection",
        features: statesGeoRaw.features.filter(f => f.properties.name)
      };
    }

    function getCountiesForState(stateFips) {
      return {
        type: "FeatureCollection",
        features: countiesGeoRaw.features.filter(f => f.properties.stateFips === stateFips)
      };
    }

    function getStateCentroids() {
      // approximate centroids for labels
      return {
        type: "FeatureCollection",
        features: statesGeoRaw.features.filter(f => f.properties.name).map(f => {
          let sumLng = 0, sumLat = 0, count = 0;
          function scan(c) { if (typeof c[0] === 'number') { sumLng += c[0]; sumLat += c[1]; count++; } else c.forEach(scan); }
          scan(f.geometry.coordinates);
          return {
            type: "Feature",
            geometry: { type: "Point", coordinates: [sumLng / count, sumLat / count] },
            properties: f.properties
          };
        })
      };
    }

    function getCountyCentroids(stateFips) {
      return {
        type: "FeatureCollection",
        features: countiesGeoRaw.features.filter(f => f.properties.stateFips === stateFips).map(f => {
          let sumLng = 0, sumLat = 0, count = 0;
          function scan(c) { if (typeof c[0] === 'number') { sumLng += c[0]; sumLat += c[1]; count++; } else c.forEach(scan); }
          scan(f.geometry.coordinates);
          return {
            type: "Feature",
            geometry: { type: "Point", coordinates: [sumLng / count, sumLat / count] },
            properties: f.properties
          };
        })
      };
    }

    // ============================================================
    // RENDER LAYERS
    // ============================================================
    const ALL_LAYERS = ['region-fill', 'region-outline', 'region-glow', 'heatmap-layer', 'permit-markers', 'permit-labels', 'label-layer', 'city-markers', 'city-labels'];
    const ALL_SOURCES = ['poly-source', 'centroids-source', 'heatmap-source', 'permits-source', 'cities-source'];

    function clearLayers() {
      ALL_LAYERS.forEach(id => { if (map.getLayer(id)) map.removeLayer(id); });
      ALL_SOURCES.forEach(id => { if (map.getSource(id)) map.removeSource(id); });
    }

    function renderLevel() {
      clearLayers();
      // Show/hide sub-mode toggle
      const smEl = document.getElementById('sub-mode-toggle');
      if (smEl) smEl.style.display = (currentLevel === 'state') ? 'flex' : 'none';

      let polyGeoJSON, centroidGeoJSON, labelField;

      if (currentLevel === 'national') {
        polyGeoJSON = getStateGeoJSON();
        centroidGeoJSON = getStateCentroids();
        labelField = ['get', 'name'];
      } else if (currentLevel === 'state' && stateSubMode === 'counties') {
        polyGeoJSON = getCountiesForState(currentStateFips);
        centroidGeoJSON = getCountyCentroids(currentStateFips);
        labelField = ['get', 'name'];
      } else if (currentLevel === 'state' && stateSubMode === 'cities') {
        // Show county outlines faded + city markers
        polyGeoJSON = getCountiesForState(currentStateFips);
        centroidGeoJSON = { type: 'FeatureCollection', features: [] };
        labelField = ['get', 'name'];
      } else if (currentLevel === 'county') {
        const cf = countiesGeoRaw.features.find(f => f.properties.fips === currentCountyFips);
        polyGeoJSON = { type: 'FeatureCollection', features: cf ? [cf] : [] };
        centroidGeoJSON = { type: 'FeatureCollection', features: [] };
        labelField = ['get', 'name'];
      } else {
        // city level - show county boundary
        const cf = countiesGeoRaw.features.find(f => f.properties.fips === currentCountyFips);
        polyGeoJSON = { type: 'FeatureCollection', features: cf ? [cf] : [] };
        centroidGeoJSON = { type: 'FeatureCollection', features: [] };
        labelField = ['get', 'name'];
      }

      // Polygon source
      map.addSource('poly-source', { type: 'geojson', data: polyGeoJSON });
      // Centroid source (for labels & heatmap)
      map.addSource('centroids-source', { type: 'geojson', data: centroidGeoJSON });

      // ---- FILL opacity: faded for cities sub-mode ----
      if (layerVisibility.choropleth) {
        const fillOpacity = (currentLevel === 'state' && stateSubMode === 'cities') ? 0.1 : 0.25;
        map.addLayer({
          id: 'region-fill',
          type: 'fill',
          source: 'poly-source',
          paint: {
            'fill-color': RATE_COLOR,
            'fill-opacity': ['case', ['boolean', ['feature-state', 'hover'], false], fillOpacity + 0.2, fillOpacity]
          }
        });
        map.addLayer({
          id: 'region-glow',
          type: 'line',
          source: 'poly-source',
          paint: { 'line-color': RATE_COLOR, 'line-width': 3, 'line-opacity': 0.2, 'line-blur': 3 }
        });
        map.addLayer({
          id: 'region-outline',
          type: 'line',
          source: 'poly-source',
          paint: { 'line-color': RATE_COLOR, 'line-width': 1, 'line-opacity': 0.5 }
        });
      }

      // ---- LABELS ----
      if (layerVisibility.choropleth && centroidGeoJSON.features.length > 0) {
        map.addLayer({
          id: 'label-layer',
          type: 'symbol',
          source: 'centroids-source',
          layout: {
            'text-field': labelField,
            'text-size': currentLevel === 'national' ? 11 : 10,
            'text-font': ['Noto Sans Medium'],
            'text-allow-overlap': false
          },
          paint: {
            'text-color': '#fff',
            'text-halo-color': 'rgba(0,0,0,0.8)',
            'text-halo-width': 1.5
          }
        });
      }

      // ---- HEATMAP ----
      if (layerVisibility.heatmap) {
        map.addSource('heatmap-source', { type: 'geojson', data: centroidGeoJSON });
        map.addLayer({
          id: 'heatmap-layer',
          type: 'heatmap',
          source: 'heatmap-source',
          paint: {
            'heatmap-weight': ['interpolate', ['linear'], ['get', 'total'], 100, 0.1, 50000, 1],
            'heatmap-intensity': 1.2,
            'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 2, 20, 9, 40],
            'heatmap-color': [
              'interpolate', ['linear'], ['heatmap-density'],
              0, 'rgba(0,0,0,0)',
              0.2, 'rgba(103,58,183,0.3)',
              0.4, 'rgba(33,150,243,0.5)',
              0.6, 'rgba(0,188,212,0.6)',
              0.8, 'rgba(255,193,7,0.7)',
              1.0, 'rgba(244,67,54,0.85)'
            ],
            'heatmap-opacity': 0.7
          }
        }, map.getLayer('region-fill') ? 'region-fill' : undefined);
      }

      // ---- CITY MARKERS (state/cities mode & county level) ----
      if ((currentLevel === 'state' && stateSubMode === 'cities') || currentLevel === 'county') {
        const citiesGeo = currentLevel === 'county'
          ? getCitiesGeoJSON(currentCountyFips)
          : getAllCitiesForState(currentStateFips);
        if (citiesGeo.features.length > 0) {
          map.addSource('cities-source', { type: 'geojson', data: citiesGeo });
          map.addLayer({
            id: 'city-markers',
            type: 'circle',
            source: 'cities-source',
            paint: {
              'circle-radius': ['interpolate', ['linear'], ['get', 'total'], 100, 8, 5000, 22],
              'circle-color': RATE_COLOR,
              'circle-opacity': 0.7,
              'circle-stroke-width': 2,
              'circle-stroke-color': 'rgba(255,255,255,0.3)'
            }
          });
          map.addLayer({
            id: 'city-labels',
            type: 'symbol',
            source: 'cities-source',
            layout: {
              'text-field': ['get', 'name'],
              'text-size': 11,
              'text-font': ['Noto Sans Medium'],
              'text-offset': [0, -1.8],
              'text-allow-overlap': false
            },
            paint: {
              'text-color': '#fff',
              'text-halo-color': 'rgba(0,0,0,0.8)',
              'text-halo-width': 1.5
            }
          });
        }
      }

      // ---- PERMIT MARKERS (city level) ----
      if (layerVisibility.markers && currentLevel === 'city') {
        const cf = countiesGeoRaw.features.find(f => f.properties.fips === currentCountyFips);
        if (cf) {
          const pts = generatePermitPoints(cf);
          map.addSource('permits-source', { type: 'geojson', data: pts });
          map.addLayer({
            id: 'permit-markers',
            type: 'circle',
            source: 'permits-source',
            paint: {
              'circle-radius': 6,
              'circle-color': ['match', ['get', 'status'], 'Approved', '#22c55e', 'Pending', '#f59e0b', 'Denied', '#ef4444', '#888'],
              'circle-stroke-width': 1,
              'circle-stroke-color': 'rgba(0,0,0,0.4)',
              'circle-opacity': 0.85
            }
          });
          map.addLayer({
            id: 'permit-labels',
            type: 'symbol',
            source: 'permits-source',
            layout: {
              'text-field': ['get', 'id'], 'text-size': 9,
              'text-font': ['Noto Sans Medium'],
              'text-offset': [0, 1.2], 'text-allow-overlap': false
            },
            paint: { 'text-color': 'rgba(255,255,255,0.5)', 'text-halo-color': 'rgba(0,0,0,0.6)', 'text-halo-width': 1 },
            minzoom: 10
          });
        }
      }
    }

    // ============================================================
    // SIDEBAR
    // ============================================================
    function getItemsForLevel() {
      if (currentLevel === 'national') return statesGeoRaw.features.filter(f => f.properties.name).map(f => f.properties);
      if (currentLevel === 'state' && stateSubMode === 'counties') return countiesGeoRaw.features.filter(f => f.properties.stateFips === currentStateFips).map(f => f.properties);
      if (currentLevel === 'state' && stateSubMode === 'cities') {
        const counties = countiesGeoRaw.features.filter(f => f.properties.stateFips === currentStateFips);
        const cities = [];
        counties.forEach(cf => cities.push(...getCitiesForCounty(cf.properties.fips)));
        return cities;
      }
      if (currentLevel === 'county') return getCitiesForCounty(currentCountyFips);
      if (currentLevel === 'city') {
        const city = getCitiesForCounty(currentCountyFips).find(c => c.name === currentCityName);
        return city ? [city] : [];
      }
      return [];
    }

    function updateSidebar() {
      const items = getItemsForLevel();
      let totalPermits = 0, totalApproved = 0, totalPending = 0, totalDenied = 0;
      items.forEach(s => { totalPermits += s.total; totalApproved += s.approved; totalPending += s.pending; totalDenied += s.denied; });

      const rate = totalPermits > 0 ? (totalApproved / totalPermits * 100).toFixed(1) : '0';
      document.getElementById('stat-total').textContent = totalPermits.toLocaleString();
      document.getElementById('stat-rate').textContent = rate + '%';
      document.getElementById('stat-pending').textContent = totalPending.toLocaleString();
      document.getElementById('stat-denied').textContent = totalDenied.toLocaleString();

      const apPct = totalPermits > 0 ? (totalApproved / totalPermits * 100) : 0;
      const pePct = totalPermits > 0 ? (totalPending / totalPermits * 100) : 0;
      const dePct = totalPermits > 0 ? (totalDenied / totalPermits * 100) : 0;
      document.getElementById('status-bar').innerHTML = `
      <div class="approved" style="width:${apPct}%"></div>
      <div class="pending" style="width:${pePct}%"></div>
      <div class="denied" style="width:${dePct}%"></div>
    `;
      document.getElementById('leg-approved').textContent = `Approved (${apPct.toFixed(0)}%)`;
      document.getElementById('leg-pending').textContent = `Pending (${pePct.toFixed(0)}%)`;
      document.getElementById('leg-denied').textContent = `Denied (${dePct.toFixed(0)}%)`;

      // Hotspots
      const sorted = [...items].sort((a, b) => b.total - a.total).slice(0, 8);
      const container = document.getElementById('hotspots-container');
      container.innerHTML = sorted.map((item, i) => `
      <div class="hotspot-item" data-idx="${i}">
        <div class="hotspot-rank">${i + 1}</div>
        <div class="hotspot-info">
          <div class="hotspot-name">${item.name}</div>
          <div class="hotspot-sub">${(item.approvalRate * 100).toFixed(0)}% approved ¬∑ ${item.avgDays}d avg</div>
        </div>
        <div class="hotspot-count">${item.total.toLocaleString()}</div>
      </div>
    `).join('');

      // Breadcrumbs
      const bc = document.getElementById('breadcrumbs');
      const sName = FIPS_TO_STATE[currentStateFips] || '';
      if (currentLevel === 'national') {
        bc.innerHTML = `<span class="breadcrumb-current">United States</span>`;
      } else if (currentLevel === 'state') {
        bc.innerHTML = `<span class="breadcrumb-item" id="bc-national">United States</span><span class="breadcrumb-sep">‚Ä∫</span><span class="breadcrumb-current">${sName} (${stateSubMode})</span>`;
        document.getElementById('bc-national').addEventListener('click', () => drillTo('national'));
      } else if (currentLevel === 'county') {
        const cf = countiesGeoRaw.features.find(f => f.properties.fips === currentCountyFips);
        const cName = cf ? cf.properties.name : '';
        bc.innerHTML = `<span class="breadcrumb-item" id="bc-national">United States</span><span class="breadcrumb-sep">‚Ä∫</span><span class="breadcrumb-item" id="bc-state">${sName}</span><span class="breadcrumb-sep">‚Ä∫</span><span class="breadcrumb-current">${cName}</span>`;
        document.getElementById('bc-national').addEventListener('click', () => drillTo('national'));
        document.getElementById('bc-state').addEventListener('click', () => drillTo('state'));
      } else if (currentLevel === 'city') {
        const cf = countiesGeoRaw.features.find(f => f.properties.fips === currentCountyFips);
        const cName = cf ? cf.properties.name : '';
        bc.innerHTML = `<span class="breadcrumb-item" id="bc-national">United States</span><span class="breadcrumb-sep">‚Ä∫</span><span class="breadcrumb-item" id="bc-state">${sName}</span><span class="breadcrumb-sep">‚Ä∫</span><span class="breadcrumb-item" id="bc-county">${cName}</span><span class="breadcrumb-sep">‚Ä∫</span><span class="breadcrumb-current">${currentCityName}</span>`;
        document.getElementById('bc-national').addEventListener('click', () => drillTo('national'));
        document.getElementById('bc-state').addEventListener('click', () => drillTo('state'));
        document.getElementById('bc-county').addEventListener('click', () => drillTo('county', currentCountyFips));
      }
    }

    // ============================================================
    // DRILL DOWN
    // ============================================================
    function drillTo(level, fips) {
      if (level === 'national') {
        currentLevel = 'national';
        currentStateFips = null;
        currentCountyFips = null;
        currentCityName = null;
        map.flyTo({ center: [-98.5, 39.8], zoom: 3.8, duration: 1200 });
      } else if (level === 'state') {
        currentLevel = 'state';
        if (fips) currentStateFips = fips;
        currentCountyFips = null;
        currentCityName = null;
        const sf = statesGeoRaw.features.find(f => f.id === currentStateFips);
        if (sf) {
          let sumLng = 0, sumLat = 0, cnt = 0;
          function scan(c) { if (typeof c[0] === 'number') { sumLng += c[0]; sumLat += c[1]; cnt++; } else c.forEach(scan); }
          scan(sf.geometry.coordinates);
          map.flyTo({ center: [sumLng / cnt, sumLat / cnt], zoom: 6, duration: 1200 });
        }
      } else if (level === 'county') {
        currentLevel = 'county';
        if (fips) currentCountyFips = fips;
        currentCityName = null;
        const cf = countiesGeoRaw.features.find(f => f.properties.fips === currentCountyFips);
        if (cf) {
          let sumLng = 0, sumLat = 0, cnt = 0;
          function scan(c) { if (typeof c[0] === 'number') { sumLng += c[0]; sumLat += c[1]; cnt++; } else c.forEach(scan); }
          scan(cf.geometry.coordinates);
          map.flyTo({ center: [sumLng / cnt, sumLat / cnt], zoom: 9, duration: 1200 });
        }
      } else if (level === 'city') {
        currentLevel = 'city';
        currentCityName = fips; // reusing fips param for city name
        const city = getCitiesForCounty(currentCountyFips).find(c => c.name === currentCityName);
        if (city) {
          map.flyTo({ center: [city.lng, city.lat], zoom: 12, duration: 1200 });
        }
      }
      renderLevel();
      updateSidebar();
    }

    // ============================================================
    // MAP INTERACTIONS
    // ============================================================
    map.on('load', () => {
      renderLevel();
      updateSidebar();

      // Click region to drill down
      map.on('click', 'region-fill', (e) => {
        if (!e.features.length) return;
        const p = e.features[0].properties;
        if (currentLevel === 'national') {
          const fips = p.fips || e.features[0].id;
          if (fips) drillTo('state', String(fips).padStart(2, '0'));
        } else if (currentLevel === 'state') {
          const fips = p.fips || e.features[0].id;
          if (fips) drillTo('county', String(fips).padStart(5, '0'));
        }
      });

      // Click city marker to drill into city
      map.on('click', 'city-markers', (e) => {
        if (!e.features.length) return;
        const p = e.features[0].properties;
        if (currentLevel === 'county') {
          drillTo('city', p.name);
        } else if (currentLevel === 'state' && stateSubMode === 'cities') {
          // Drill to the county first, then show cities
          if (p.countyFips) drillTo('county', p.countyFips);
        }
      });

      // Hover for regions
      function showHoverInfo(e) {
        map.getCanvas().style.cursor = 'pointer';
        if (!e.features.length) return;
        const p = e.features[0].properties;
        const hi = document.getElementById('hover-info');
        hi.classList.add('visible');
        document.getElementById('hi-name').textContent = p.name || '';
        document.getElementById('hi-total').textContent = Number(p.total).toLocaleString();
        document.getElementById('hi-approved').textContent = Number(p.approved).toLocaleString();
        document.getElementById('hi-pending').textContent = Number(p.pending).toLocaleString();
        document.getElementById('hi-denied').textContent = Number(p.denied).toLocaleString();
        document.getElementById('hi-rate').textContent = (Number(p.rate) * 100).toFixed(1) + '%';
      }
      function hideHoverInfo() {
        map.getCanvas().style.cursor = '';
        document.getElementById('hover-info').classList.remove('visible');
      }
      map.on('mousemove', 'region-fill', showHoverInfo);
      map.on('mouseleave', 'region-fill', hideHoverInfo);
      map.on('mousemove', 'city-markers', showHoverInfo);
      map.on('mouseleave', 'city-markers', hideHoverInfo);

      // Permit popup
      map.on('click', 'permit-markers', (e) => {
        if (!e.features.length) return;
        const p = e.features[0].properties;
        const coords = e.features[0].geometry.coordinates;
        new maplibregl.Popup({ maxWidth: '220px' })
          .setLngLat(coords)
          .setHTML(`
          <div style="font-family:Inter,sans-serif;font-size:13px;color:#222;">
            <strong>${p.id}</strong><br/>
            <span style="color:${p.status === 'Approved' ? '#16a34a' : p.status === 'Pending' ? '#d97706' : '#dc2626'};font-weight:600;">${p.status}</span><br/>
            Type: ${p.type}<br/>
            Processing: ${p.days} days
          </div>
        `)
          .addTo(map);
      });
    });

    // ============================================================
    // LAYER TOGGLES
    // ============================================================
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const layer = btn.dataset.layer;
        layerVisibility[layer] = !layerVisibility[layer];
        btn.classList.toggle('active', layerVisibility[layer]);
        renderLevel();
      });
    });

    // ============================================================
    // SUB-MODE TOGGLE (Counties / Cities) ‚Äî only visible at state level
    // ============================================================
    const subModeContainer = document.createElement('div');
    subModeContainer.id = 'sub-mode-toggle';
    subModeContainer.className = 'layer-toggles';
    subModeContainer.style.display = 'none';
    subModeContainer.style.marginLeft = '0';
    subModeContainer.innerHTML = `
      <button class="toggle-btn active" data-sm="counties">üèõÔ∏è Counties</button>
      <button class="toggle-btn" data-sm="cities">üèôÔ∏è Cities</button>
    `;
    document.querySelector('.map-controls').appendChild(subModeContainer);
    subModeContainer.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        stateSubMode = btn.dataset.sm;
        subModeContainer.querySelectorAll('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.sm === stateSubMode));
        renderLevel();
        updateSidebar();
      });
    });

    // ============================================================
    // SEARCH
    // ============================================================
    const searchInput = document.getElementById('search-input');
    const searchResultsEl = document.getElementById('search-results');
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      const q = searchInput.value.trim();
      if (q.length < 2) { searchResultsEl.classList.remove('active'); return; }
      searchTimeout = setTimeout(() => {
        // Search states
        const stateMatches = statesGeoRaw.features
          .filter(f => f.properties.name && f.properties.name.toLowerCase().includes(q.toLowerCase()))
          .slice(0, 5);
        if (stateMatches.length) {
          searchResultsEl.innerHTML = stateMatches.map(f =>
            `<div class="search-result-item" data-type="state" data-fips="${f.id}">${f.properties.name} (${Number(f.properties.total).toLocaleString()} permits)</div>`
          ).join('');
          searchResultsEl.classList.add('active');
          searchResultsEl.querySelectorAll('.search-result-item').forEach(item => {
            item.addEventListener('click', () => {
              drillTo('state', item.dataset.fips);
              searchInput.value = '';
              searchResultsEl.classList.remove('active');
            });
          });
          return;
        }
        // Nominatim fallback
        fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`)
          .then(r => r.json())
          .then(data => {
            if (!data.length) { searchResultsEl.classList.remove('active'); return; }
            searchResultsEl.innerHTML = data.map(d =>
              `<div class="search-result-item" data-lon="${d.lon}" data-lat="${d.lat}">${d.display_name}</div>`
            ).join('');
            searchResultsEl.classList.add('active');
            searchResultsEl.querySelectorAll('.search-result-item').forEach(item => {
              item.addEventListener('click', () => {
                map.flyTo({ center: [parseFloat(item.dataset.lon), parseFloat(item.dataset.lat)], zoom: 10, duration: 1500 });
                searchInput.value = '';
                searchResultsEl.classList.remove('active');
              });
            });
          });
      }, 300);
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-box')) searchResultsEl.classList.remove('active');
    });
  </script>
</body>

</html>